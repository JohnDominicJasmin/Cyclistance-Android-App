Index: app/src/main/AndroidManifest.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<manifest xmlns:tools=\"http://schemas.android.com/tools\"\r\n    xmlns:android=\"http://schemas.android.com/apk/res/android\">\r\n\r\n    <uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\" />\r\n    <uses-permission android:name=\"android.permission.INTERNET\" />\r\n    <uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\" />\r\n    <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\" />\r\n    <uses-permission android:name=\"android.permission.ACCESS_BACKGROUND_LOCATION\" />\r\n    <uses-permission android:name=\"android.permission.FOREGROUND_SERVICE\" />\r\n    <uses-permission android:name=\"android.permission.READ_EXTERNAL_STORAGE\" />\r\n    <uses-permission android:name=\"android.permission.CAMERA\" />\r\n    <uses-feature android:name=\"android.hardware.camera.any\" />\r\n    <uses-permission android:name=\"android.permission.WRITE_EXTERNAL_STORAGE\" />\r\n    <uses-permission android:name=\"android.permission.ACCESS_WIFI_STATE\" />\r\n    <uses-permission android:name=\"android.permission.CALL_PHONE\" />\r\n    <uses-permission android:name=\"android.permission.POST_NOTIFICATIONS\"/>\r\n\r\n    <uses-feature android:glEsVersion=\"0x00030001\" android:required=\"true\" />\r\n    <uses-feature\r\n        android:name=\"android.hardware.camera\"\r\n        android:required=\"false\" />\r\n    <uses-feature\r\n        android:name=\"android.hardware.telephony\"\r\n        android:required=\"false\" />\r\n\r\n    <application\r\n        android:name=\"com.example.cyclistance.BaseApplication\"\r\n        android:allowBackup=\"true\"\r\n        android:hardwareAccelerated=\"true\"\r\n        android:icon=\"@mipmap/ic_launcher\"\r\n        android:label=\"@string/app_name\"\r\n        android:roundIcon=\"@mipmap/ic_launcher_round\"\r\n        android:supportsRtl=\"true\"\r\n        android:theme=\"@style/Theme.Cyclistance\"\r\n        android:largeHeap=\"true\"\r\n        android:usesCleartextTraffic=\"true\">\r\n\r\n\r\n\r\n        <service\r\n            android:name=\".service.LocationService\"\r\n            android:foregroundServiceType=\"location\" />\r\n\r\n\r\n        <activity\r\n            android:name=\"com.example.cyclistance.MainActivity\"\r\n            android:configChanges=\"keyboard|keyboardHidden|orientation|screenSize\"\r\n            android:exported=\"true\"\r\n            android:windowSoftInputMode=\"adjustResize\"\r\n            android:hardwareAccelerated=\"true\"\r\n            android:largeHeap=\"true\"\r\n            android:launchMode=\"singleTop\"\r\n            android:theme=\"@style/Theme.Cyclistance\">\r\n            <intent-filter>\r\n                <action android:name=\"android.intent.action.MAIN\" />\r\n                <category android:name=\"android.intent.category.LAUNCHER\" />\r\n            </intent-filter>\r\n        </activity>\r\n\r\n        <provider\r\n            android:name=\"androidx.core.content.FileProvider\"\r\n            android:authorities=\"${applicationId}.provider\"\r\n            android:exported=\"false\"\r\n            android:grantUriPermissions=\"true\">\r\n            <meta-data\r\n                android:name=\"android.support.FILE_PROVIDER_PATHS\"\r\n                android:resource=\"@xml/provider_paths\" />\r\n\r\n        </provider>\r\n\r\n        <meta-data\r\n            android:name=\"com.facebook.sdk.ApplicationId\"\r\n            android:value=\"@string/FacebookAppID\" />\r\n        <meta-data\r\n            android:name=\"com.facebook.sdk.ClientToken\"\r\n            android:value=\"@string/FacebookClientToken\" />\r\n\r\n        <activity\r\n            android:name=\"com.facebook.FacebookActivity\"\r\n            android:configChanges=\"keyboard|keyboardHidden|screenLayout|screenSize|orientation\" />\r\n        <activity\r\n            android:name=\"com.facebook.CustomTabActivity\"\r\n            android:exported=\"true\">\r\n            <intent-filter>\r\n                <action android:name=\"android.intent.action.VIEW\" />\r\n\r\n                <category android:name=\"android.intent.category.DEFAULT\" />\r\n                <category android:name=\"android.intent.category.BROWSABLE\" />\r\n\r\n                <data android:scheme=\"@string/FacebookLoginProtocolScheme\" />\r\n            </intent-filter>\r\n        </activity>\r\n\r\n        <service\r\n            android:name=\"com.example.cyclistance.service.MessagingService\"\r\n            android:exported=\"false\"\r\n            tools:ignore=\"Instantiatable\">\r\n            <intent-filter>\r\n                <action android:name=\"com.google.firebase.MESSAGING_EVENT\" />\r\n            </intent-filter>\r\n        </service>\r\n\r\n    </application>\r\n\r\n</manifest>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/AndroidManifest.xml b/app/src/main/AndroidManifest.xml
--- a/app/src/main/AndroidManifest.xml	(revision 82f4565203882eae66546dba49ffc9a44ba8ccd7)
+++ b/app/src/main/AndroidManifest.xml	(date 1696922159031)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="utf-8"?>
-<manifest xmlns:tools="http://schemas.android.com/tools"
-    xmlns:android="http://schemas.android.com/apk/res/android">
+<manifest xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools">
 
     <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
     <uses-permission android:name="android.permission.INTERNET" />
@@ -10,13 +10,17 @@
     <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
     <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
     <uses-permission android:name="android.permission.CAMERA" />
+
     <uses-feature android:name="android.hardware.camera.any" />
+
     <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
     <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
     <uses-permission android:name="android.permission.CALL_PHONE" />
-    <uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
+    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
 
-    <uses-feature android:glEsVersion="0x00030001" android:required="true" />
+    <uses-feature
+        android:glEsVersion="0x00030001"
+        android:required="true" />
     <uses-feature
         android:name="android.hardware.camera"
         android:required="false" />
@@ -30,14 +34,13 @@
         android:hardwareAccelerated="true"
         android:icon="@mipmap/ic_launcher"
         android:label="@string/app_name"
+        android:largeHeap="true"
         android:roundIcon="@mipmap/ic_launcher_round"
         android:supportsRtl="true"
         android:theme="@style/Theme.Cyclistance"
-        android:largeHeap="true"
         android:usesCleartextTraffic="true">
 
 
-
         <service
             android:name=".service.LocationService"
             android:foregroundServiceType="location" />
@@ -47,14 +50,24 @@
             android:name="com.example.cyclistance.MainActivity"
             android:configChanges="keyboard|keyboardHidden|orientation|screenSize"
             android:exported="true"
-            android:windowSoftInputMode="adjustResize"
             android:hardwareAccelerated="true"
             android:largeHeap="true"
-            android:launchMode="singleTop"
-            android:theme="@style/Theme.Cyclistance">
+            android:launchMode="singleTask"
+            android:theme="@style/Theme.Cyclistance"
+            android:windowSoftInputMode="adjustResize">
             <intent-filter>
                 <action android:name="android.intent.action.MAIN" />
                 <category android:name="android.intent.category.LAUNCHER" />
+            </intent-filter>
+            <intent-filter>
+                <action android:name="android.intent.action.VIEW" />
+
+                <category android:name="android.intent.category.DEFAULT" />
+                <category android:name="android.intent.category.BROWSABLE" />
+
+                <data
+                    android:host="messaging"
+                    android:scheme="cyclistance" />
             </intent-filter>
         </activity>
 
Index: app/src/main/java/com/example/cyclistance/service/MessagingService.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.cyclistance.service\r\n\r\nimport android.Manifest\r\nimport android.annotation.SuppressLint\r\nimport android.app.PendingIntent\r\nimport android.app.TaskStackBuilder\r\nimport android.content.Intent\r\nimport android.content.pm.PackageManager\r\nimport android.os.Build\r\nimport androidx.core.app.NotificationCompat\r\nimport androidx.core.app.NotificationManagerCompat\r\nimport androidx.core.net.toUri\r\nimport com.example.cyclistance.MainActivity\r\nimport com.example.cyclistance.core.utils.constants.MessagingConstants.CONVERSATION_ID\r\nimport com.example.cyclistance.core.utils.constants.MessagingConstants.KEY_MESSAGE\r\nimport com.example.cyclistance.core.utils.constants.MessagingConstants.MESSAGING_URI\r\nimport com.example.cyclistance.core.utils.constants.MessagingConstants.NOTIFICATION_ID\r\nimport com.example.cyclistance.core.utils.constants.UtilConstants.KEY_NAME\r\nimport com.google.firebase.messaging.FirebaseMessagingService\r\nimport com.google.firebase.messaging.RemoteMessage\r\nimport dagger.hilt.android.AndroidEntryPoint\r\nimport timber.log.Timber\r\nimport javax.inject.Inject\r\nimport javax.inject.Named\r\n\r\n@AndroidEntryPoint\r\nclass MessagingService : FirebaseMessagingService() {\r\n\r\n    @Inject lateinit var notificationManager: NotificationManagerCompat\r\n    @Inject @Named(\"messagingNotification\") lateinit var notificationBuilder: NotificationCompat.Builder\r\n\r\n    override fun onNewToken(token: String) {\r\n        super.onNewToken(token)\r\n        Timber.v(\"FirebaseMessagingService New token: $token\")\r\n    }\r\n\r\n\r\n    @SuppressLint(\"MissingPermission\")\r\n    override fun onMessageReceived(message: RemoteMessage) {\r\n        super.onMessageReceived(message)\r\n\r\n        val data = message.data\r\n        val conversationId = data[CONVERSATION_ID]!!\r\n        val name = data[KEY_NAME]!!\r\n        val receivedMessage = data[KEY_MESSAGE] ?: \"\"\r\n\r\n\r\n        val uri =  \"$MESSAGING_URI/$CONVERSATION_ID=$conversationId\".toUri()\r\n        val clickIntent = Intent(\r\n            Intent.ACTION_VIEW,\r\n            uri,\r\n            this,\r\n            MainActivity::class.java\r\n        )\r\n        val clickPendingIntent: PendingIntent = TaskStackBuilder.create(this).run {\r\n            addNextIntentWithParentStack(clickIntent)\r\n            getPendingIntent(1, PendingIntent.FLAG_MUTABLE or PendingIntent.FLAG_UPDATE_CURRENT)\r\n        }\r\n\r\n        val notificationStyle = NotificationCompat.BigTextStyle().bigText(receivedMessage)\r\n        val notificationCompat = notificationBuilder.apply {\r\n            setContentIntent(clickPendingIntent)\r\n            setContentTitle(\"Message from $name\")\r\n            setContentText(receivedMessage)\r\n            setStyle(notificationStyle)\r\n        }\r\n        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {\r\n            if (checkSelfPermission(Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {\r\n                return\r\n            }\r\n        }\r\n\r\n        notificationManager.notify(NOTIFICATION_ID, notificationCompat.build())\r\n\r\n\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\n\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/cyclistance/service/MessagingService.kt b/app/src/main/java/com/example/cyclistance/service/MessagingService.kt
--- a/app/src/main/java/com/example/cyclistance/service/MessagingService.kt	(revision 82f4565203882eae66546dba49ffc9a44ba8ccd7)
+++ b/app/src/main/java/com/example/cyclistance/service/MessagingService.kt	(date 1696922159063)
@@ -3,14 +3,12 @@
 import android.Manifest
 import android.annotation.SuppressLint
 import android.app.PendingIntent
-import android.app.TaskStackBuilder
 import android.content.Intent
 import android.content.pm.PackageManager
 import android.os.Build
 import androidx.core.app.NotificationCompat
 import androidx.core.app.NotificationManagerCompat
 import androidx.core.net.toUri
-import com.example.cyclistance.MainActivity
 import com.example.cyclistance.core.utils.constants.MessagingConstants.CONVERSATION_ID
 import com.example.cyclistance.core.utils.constants.MessagingConstants.KEY_MESSAGE
 import com.example.cyclistance.core.utils.constants.MessagingConstants.MESSAGING_URI
@@ -39,23 +37,27 @@
     override fun onMessageReceived(message: RemoteMessage) {
         super.onMessageReceived(message)
 
-        val data = message.data
-        val conversationId = data[CONVERSATION_ID]!!
-        val name = data[KEY_NAME]!!
-        val receivedMessage = data[KEY_MESSAGE] ?: ""
+        var messageData = message.data
+        val conversationId = messageData[CONVERSATION_ID]!!
+        val name = messageData[KEY_NAME]!!
+        val receivedMessage = messageData[KEY_MESSAGE] ?: ""
 
 
         val uri =  "$MESSAGING_URI/$CONVERSATION_ID=$conversationId".toUri()
         val clickIntent = Intent(
             Intent.ACTION_VIEW,
             uri,
+
+        ).apply {
+            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP or Intent.FLAG_ACTIVITY_SINGLE_TOP
+        }
+
+        val clickPendingIntent: PendingIntent = PendingIntent.getActivity(
             this,
-            MainActivity::class.java
-        )
-        val clickPendingIntent: PendingIntent = TaskStackBuilder.create(this).run {
-            addNextIntentWithParentStack(clickIntent)
-            getPendingIntent(1, PendingIntent.FLAG_MUTABLE or PendingIntent.FLAG_UPDATE_CURRENT)
-        }
+            0,
+            clickIntent,
+            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE)
+
 
         val notificationStyle = NotificationCompat.BigTextStyle().bigText(receivedMessage)
         val notificationCompat = notificationBuilder.apply {
